<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />

  <!-- iOS 添加到主屏幕 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="音频提取" />

  <link rel="manifest" href="./manifest.webmanifest" />
  <title>本地视频 → 一键提取 MP3（iPhone）</title>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, Arial, sans-serif; margin: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #111827; background: #111827; color: #fff; }
    button:disabled { opacity: .5; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .muted { color: #6b7280; font-size: 13px; }
    progress { width: 100%; height: 14px; }
    a.btn {
      display: inline-block; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #111827; text-decoration: none; color: #111827;
    }
    select, input[type="file"] { width: 100%; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h2>本地视频 → 一键提取 MP3</h2>
  <p class="muted">只处理你自己拥有/有授权的视频；全程在 iPhone 本地浏览器完成，不上传。</p>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept="video/*" />
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <label class="muted" for="format">导出格式：</label>
      <select id="format">
        <option value="mp3" selected>MP3（默认）</option>
        <option value="m4a">M4A/AAC（更省空间，苹果更快）</option>
        <option value="wav">WAV（无损，体积大）</option>
      </select>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <button id="run">开始提取</button>
      <button id="cancel" style="background:#374151;border-color:#374151;">取消</button>
    </div>

    <div style="height:12px"></div>
    <progress id="prog" value="0" max="1"></progress>
    <div id="status" class="muted" style="margin-top:8px;">准备就绪：你可以先点“开始提取”加载引擎（首次稍慢）。</div>
    <div class="muted" style="margin-top:6px;">提示：iPhone 视频太大/太长可能会失败，先用短视频测试。</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">下载</h3>
    <div class="row" id="links">
      <span class="muted">尚未生成文件。</span>
    </div>
    <p class="muted" style="margin-top:10px;">
      iPhone 下载后通常会进“文件”App（iCloud Drive/下载项）或 Safari 下载列表。
    </p>
  </div>

  <div class="card">
    <h3 style="margin-top:0">日志</h3>
    <div id="log" class="mono"></div>
  </div>

  <script type="module">
    // PWA 缓存（可选）
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }

    // ✅ iPhone 更稳：使用 jsDelivr + toBlobURL 显式加载 core/wasm/worker
    import { FFmpeg } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js";
    import { fetchFile, toBlobURL } from "https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js";

    const $ = (id) => document.getElementById(id);
    const fileInput = $("file");
    const formatSel = $("format");
    const runBtn = $("run");
    const cancelBtn = $("cancel");
    const prog = $("prog");
    const status = $("status");
    const links = $("links");
    const logBox = $("log");

    // 默认 MP3
    formatSel.value = "mp3";

    const ffmpeg = new FFmpeg();
    let loaded = false;
    let loading = false;

    function log(msg) {
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }
    function setStatus(msg) { status.textContent = msg; }
    function clearLinks() { links.innerHTML = '<span class="muted">尚未生成文件。</span>'; }
    function addLink(label, url, filename) {
      const a = document.createElement("a");
      a.className = "btn";
      a.href = url;
      a.download = filename;
      a.textContent = label;
      links.appendChild(a);
    }

    async function ensureLoaded() {
      if (loaded) return true;
      if (loading) return false;
      loading = true;

      try {
        setStatus("正在加载处理引擎（首次会稍慢）…");
        log("[init] loading ffmpeg core...");

        ffmpeg.on("log", ({ message }) => log(message));
        ffmpeg.on("progress", ({ progress }) => {
          prog.value = progress || 0;
        });

        // 关键：把 core/wasm/worker 转成 blob URL，减少 iOS/Safari 跨域/缓存怪问题
        const baseURL = "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm";
        await ffmpeg.load({
          coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, "text/javascript"),
          wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, "application/wasm"),
          workerURL: await toBlobURL(`${baseURL}/ffmpeg-core.worker.js`, "text/javascript"),
        });

        loaded = true;
        setStatus("引擎已就绪 ✅（现在选视频再提取会更稳）");
        log("[init] loaded");
        return true;
      } catch (e) {
        log("[init:error] " + (e?.message || String(e)));
        setStatus("引擎加载失败：可能是网络/CDN 被拦/缓存问题。请换网络或清 Safari 网站数据后再试。");
        return false;
      } finally {
        loading = false;
      }
    }

    // 取消：iPhone 上最稳就是刷新释放内存
    cancelBtn.addEventListener("click", () => location.reload());

    fileInput.addEventListener("change", () => {
      clearLinks();
      prog.value = 0;

      const f = fileInput.files?.[0];
      if (!f) return;
      setStatus(`已选择：${f.name}（${(f.size/1024/1024).toFixed(2)} MB）`);
    });

    runBtn.addEventListener("click", async () => {
      clearLinks();
      prog.value = 0;

      // 先确保引擎加载完成（你也可以先不选视频就点一次“开始提取”来预加载）
      const ok = await ensureLoaded();
      if (!ok) return;

      const f = fileInput.files?.[0];
      if (!f) {
        setStatus("引擎已就绪 ✅ 现在请选择一个视频文件再点“开始提取”。");
        return;
      }

      runBtn.disabled = true;
      cancelBtn.disabled = true;

      try {
        const ext = (f.name.split(".").pop() || "mp4").toLowerCase();
        const inputFile = `input.${ext}`;

        setStatus("正在读取文件…");
        await ffmpeg.writeFile(inputFile, await fetchFile(f));

        // 视频原文件下载
        links.innerHTML = "";
        addLink("下载视频（原文件）", URL.createObjectURL(f), f.name);

        const fmt = formatSel.value;
        const outBase = f.name.replace(/\.[^.]+$/, "");
        const outFile = `${outBase}.${fmt}`;

        setStatus("正在提取音频…");

        let args;
        if (fmt === "mp3") {
          args = ["-i", inputFile, "-vn", "-codec:a", "libmp3lame", "-q:a", "3", outFile];
        } else if (fmt === "wav") {
          args = ["-i", inputFile, "-vn", "-acodec", "pcm_s16le", outFile];
        } else {
          args = ["-i", inputFile, "-vn", "-c:a", "aac", "-b:a", "192k", outFile];
        }

        await ffmpeg.exec(args);

        setStatus("正在生成下载文件…");
        const data = await ffmpeg.readFile(outFile);

        const mime =
          fmt === "wav" ? "audio/wav" :
          fmt === "mp3" ? "audio/mpeg" :
          "audio/mp4";

        const audioBlob = new Blob([data.buffer], { type: mime });
        const audioUrl = URL.createObjectURL(audioBlob);

        addLink(`下载音频（${fmt.toUpperCase()}）`, audioUrl, outFile);

        setStatus("完成 ✅");
      } catch (e) {
        log("[error] " + (e?.message || String(e)));
        setStatus("失败：可能是 iPhone 内存限制/视频过大/编码不支持。先用更短的视频试试。");
      } finally {
        runBtn.disabled = false;
        cancelBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
